# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ëª¨ë“ˆì„ ì„í¬íŠ¸í•©ë‹ˆë‹¤.
import os  # íŒŒì¼ ê²½ë¡œ, í™˜ê²½ ë³€ìˆ˜ ë“± ìš´ì˜ì²´ì œ ê¸°ëŠ¥ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.
import json  # JSON ë°ì´í„°ë¥¼ ë‹¤ë£¨ê¸° ìœ„í•´ ì‚¬ìš©í•˜ì§€ë§Œ, ì´ ì½”ë“œì—ì„œëŠ” ì§ì ‘ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
from typing import TypedDict, Optional, Any, Dict, List  # íƒ€ì… íŒíŠ¸
from pathlib import Path  # íŒŒì¼ ì‹œìŠ¤í…œ ê²½ë¡œë¥¼ ê°ì²´ì§€í–¥ì ìœ¼ë¡œ ë‹¤ë£¨ê¸° ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.
from dotenv import load_dotenv, find_dotenv  # .env ë¡œë”
import hashlib  # ë°ì´í„°ì˜ í•´ì‹œê°’ì„ ìƒì„±
import sys      # âœ¨ ì§„í–‰ë¥  ì¶œë ¥ìš©
import time     # âœ¨ ETA ê³„ì‚°ìš©
import math     # âœ¨ ì‹œê°„ í¬ë§· ë“±ì— ì‚¬ìš©

# LangChainê³¼ ê´€ë ¨ëœ í´ë˜ìŠ¤ë“¤ì„ ì„í¬íŠ¸í•©ë‹ˆë‹¤.
from langchain_community.document_loaders import TextLoader, PyPDFLoader  # íŒŒì¼ ë¡œë”
from langchain_text_splitters import RecursiveCharacterTextSplitter  # í…ìŠ¤íŠ¸ ë¶„í• ê¸°
from langchain_huggingface import HuggingFaceEmbeddings  # ì„ë² ë”© ëª¨ë¸
from langchain_community.vectorstores import Milvus  # Milvus ë²¡í„°ìŠ¤í† ì–´
from langchain_core.documents import Document  # ë¬¸ì„œ êµ¬ì¡°

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv(find_dotenv())

# Milvus / Embedding ì„¤ì •
MILVUS_URI = os.getenv("MILVUS_URI", "http://localhost:19530")
MILVUS_TOKEN = os.getenv("MILVUS_TOKEN", "root:milvus")
MILVUS_COLLECTION = os.getenv("MILVUS_COLLECTION", "hongyoungjun")
EMBED_MODEL_NAME = os.getenv("EMBED_MODEL_NAME", "jhgan/ko-sroberta-multitask")

# ì…ë ¥ ë¬¸ì„œ í´ë”
DOCS_DIR = Path(os.getenv("DOCS_DIR", r"C:\Rookies_project\cropinfo"))
DOCS_DIR.mkdir(parents=True, exist_ok=True)

# ì²­í¬/ì„ë² ë”© íŒŒë¼ë¯¸í„°
CHUNK_SIZE = int(os.getenv("CHUNK_SIZE", "800"))
CHUNK_OVERLAP = int(os.getenv("CHUNK_OVERLAP", "120"))

# âœ¨ ì„ë² ë”© ì§„í–‰ë¥  ì„¤ì •(í™˜ê²½ë³€ìˆ˜ë¡œ ì¡°ì • ê°€ëŠ¥)
EMBED_BATCH_SIZE = int(os.getenv("EMBED_BATCH_SIZE", "32"))              # ë°°ì¹˜ í¬ê¸°
EMBED_PROGRESS_INTERVAL = float(os.getenv("EMBED_PROGRESS_INTERVAL", "0.2"))  # ì´ˆ ë‹¨ìœ„ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ìµœì†Œ ê°„ê²©

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Embeddings
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
embedding_model = HuggingFaceEmbeddings(
    model_name=EMBED_MODEL_NAME,
    model_kwargs={"device": "cpu"}
)
EMBEDDING_DIM = len(embedding_model.embed_query("test"))

# âœ¨ ì§„í–‰ë¥ /ETA í‘œì‹œìš© ìœ í‹¸
def _format_eta(seconds: Optional[float]) -> str:
    if not seconds or seconds < 0 or math.isinf(seconds) or math.isnan(seconds):
        return "--:--"
    m, s = divmod(int(seconds), 60)
    if m >= 60:
        h, m = divmod(m, 60)
        return f"{h:02d}:{m:02d}:{s:02d}"
    return f"{m:02d}:{s:02d}"

def _render_progress(prefix: str, done: int, total: int, start_ts: float) -> None:
    done = min(done, total)
    percent = int((done / total) * 100) if total else 100
    elapsed = time.time() - start_ts
    rate = (done / elapsed) if elapsed > 0 else None
    remain = ((total - done) / rate) if rate else None
    eta = _format_eta(remain)
    bar_len = 24
    filled = int(bar_len * percent / 100)
    bar = "â–ˆ" * filled + "â–‘" * (bar_len - filled)
    sys.stdout.write(f"\r{prefix} [{bar}] {percent:3d}%  ({done}/{total})  ETA {eta}")
    sys.stdout.flush()
    if done >= total:
        sys.stdout.write("\n")

# âœ¨ ì„ë² ë”© ì§„í–‰ë¥ ì„ í‘œì‹œí•˜ëŠ” ë˜í¼
class ProgressEmbeddings:
    """
    LangChain ì„ë² ë”© ì¸í„°í˜ì´ìŠ¤ë¥¼ ê°ì‹¸ì„œ embed_documents í˜¸ì¶œ ì‹œ
    ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì§„í–‰ë¥ (0~100%)ê³¼ ETAë¥¼ ì½˜ì†”ì— í‘œì‹œí•©ë‹ˆë‹¤.
    """
    def __init__(self, base: HuggingFaceEmbeddings, total_texts: int, batch_size: int = 32, desc: str = "ì„ë² ë”©"):
        self.base = base
        self.total_texts = max(total_texts, 1)
        self.batch_size = max(1, batch_size)
        self.desc = desc
        self._last_print = 0.0

    # LangChain ì¸í„°í˜ì´ìŠ¤ ìœ ì§€
    def embed_query(self, text: str) -> List[float]:
        return self.base.embed_query(text)

    def embed_documents(self, texts: List[str]) -> List[List[float]]:
        n = len(texts)
        # Milvus.from_documents ê°€ í•œ ë²ˆì— texts ì „ì²´ë¥¼ ë„˜ê¸°ë¯€ë¡œ, ë‚´ë¶€ì—ì„œ ë°°ì¹˜ë¡œ ë‚˜ëˆ  ì§„í–‰ë¥  í‘œì‹œ
        total = n
        start_ts = time.time()
        results: List[List[float]] = []
        processed = 0

        # ì²« ë©”ì‹œì§€
        print(f"ğŸ§® {self.desc} ì‹œì‘: ì´ {total}ê°œ ì²­í¬ | ë°°ì¹˜ {self.batch_size} | ì§„í–‰ë¥  ë° ETA í‘œì¶œ")

        for i in range(0, n, self.batch_size):
            batch = texts[i:i + self.batch_size]

            # ì‹¤ì œ ì„ë² ë”© ê³„ì‚°
            emb = self.base.embed_documents(batch)
            results.extend(emb)
            processed = min(i + len(batch), total)

            # ë„ˆë¬´ ì¦ì€ ì¶œë ¥ ë°©ì§€(EMBED_PROGRESS_INTERVAL ê°„ê²©)
            now = time.time()
            if now - self._last_print >= EMBED_PROGRESS_INTERVAL or processed == total:
                _render_progress("ğŸ”„ ì„ë² ë”©", processed, total, start_ts)
                self._last_print = now

        # ì™„ë£Œ ë¼ì¸ ë³´ì¥
        _render_progress("âœ… ì„ë² ë”©", total, total, start_ts)
        return results

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìƒíƒœ ì •ì˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class IngestState(TypedDict):
    docsPath: str
    files: List[str]
    rawDocs: List[Document]
    vectorstore: Optional[Milvus]
    inserted: int
    collectionName: str

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LangGraph ë…¸ë“œë“¤
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from langgraph.graph import StateGraph, END
from langchain_core.runnables.graph import MermaidDrawMethod
from pymilvus import connections, MilvusClient, DataType

def ensure_milvus_node(state: IngestState) -> IngestState:
    print("ğŸ§© ë…¸ë“œ: ensure_milvus (ì»¬ë ‰ì…˜ í™•ì¸)")
    if "default" in connections.list_connections():
        connections.disconnect("default")
    connections.connect(alias="default", host="localhost", port="19530")

    client = MilvusClient(uri=MILVUS_URI, token=MILVUS_TOKEN)
    if client.has_collection(MILVUS_COLLECTION):
        print(f"  â†ª ê¸°ì¡´ ì»¬ë ‰ì…˜ '{MILVUS_COLLECTION}' ì‚­ì œ")
        client.drop_collection(MILVUS_COLLECTION)
    print(f"  â†ª Milvus ì—°ê²° ë° ì»¬ë ‰ì…˜ ì¤€ë¹„ ì™„ë£Œ.")
    return state

def list_files_node(state: IngestState) -> IngestState:
    print("ğŸ§© ë…¸ë“œ: list_files")
    docs_path = Path(state["docsPath"])
    allow_ext = {".txt", ".md", ".pdf"}
    files = [str(p) for p in sorted(docs_path.rglob("*")) if p.is_file() and p.suffix.lower() in allow_ext]
    print(f"  â†ª ëŒ€ìƒ íŒŒì¼ {len(files)}ê°œ")
    if not files:
        print("  âš ï¸ 'ingest_docs' í´ë”ì— .txt/.md/.pdf íŒŒì¼ì„ ë„£ì–´ì£¼ì„¸ìš”.")
    return {**state, "files": files}

def load_and_ingest_node(state: IngestState) -> IngestState:
    print("ğŸ§© ë…¸ë“œ: load_and_ingest_node (ë¬¸ì„œ ë¡œë“œ & Milvusì— ì¸ì œìŠ¤íŠ¸)")
    all_docs: List[Document] = []
    text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=CHUNK_SIZE,
        chunk_overlap=CHUNK_OVERLAP,
        length_function=len,
    )

    # ë¡œë“œ & ì²­í¬
    for fp in state["files"]:
        path = Path(fp)
        try:
            if path.suffix.lower() in {".txt", ".md"}:
                docs = TextLoader(str(path), autodetect_encoding=True).load()
            elif path.suffix.lower() == ".pdf":
                docs = PyPDFLoader(str(path)).load()
            else:
                continue

            for d in docs:
                d.metadata.setdefault("source", str(path.name))
                if "page" not in d.metadata:
                    d.metadata["page"] = 0

            chunks = text_splitter.split_documents(docs)
            all_docs.extend(chunks)
            print(f"  â†ª ë¡œë“œ ë° ì²­í¬ ì™„ë£Œ: {path.name} ({len(chunks)}ê°œ ì²­í¬)")

        except Exception as e:
            print(f"  âš ï¸ ì²˜ë¦¬ ì‹¤íŒ¨: {path.name} | {e}")

    if not all_docs:
        print("  âš ï¸ ì²˜ë¦¬í•  ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.")
        return {**state, "inserted": 0, "rawDocs": [], "vectorstore": None}

    print(f"ğŸ†• ì´ {len(all_docs)}ê°œ ì²­í¬ë¥¼ ë²¡í„°ìŠ¤í† ì–´ì— ì‚½ì… ì¤‘...")

    # âœ¨ ì§„í–‰ë¥  í‘œì‹œìš© ì„ë² ë”© ë˜í¼ ì ìš©
    try:
        progress_embedder = ProgressEmbeddings(
            base=embedding_model,
            total_texts=len(all_docs),
            batch_size=EMBED_BATCH_SIZE,
            desc="ì„ë² ë”©"
        )

        # Milvus.from_documents ë‚´ë¶€ì—ì„œ embed_documentsë¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ,
        # ProgressEmbeddingsê°€ ë°°ì¹˜/ì§„í–‰ë¥ /ETAë¥¼ ì½˜ì†”ì— ì¶œë ¥í•©ë‹ˆë‹¤.
        vectorstore = Milvus.from_documents(
            documents=all_docs,
            embedding=progress_embedder,  # âœ¨ ì—¬ê¸°ì„œ ì§„í–‰ë¥  ì¶œë ¥
            collection_name=state["collectionName"],
            connection_args={"host": "localhost", "port": "19530"}
        )
        print("âœ… ë²¡í„°ìŠ¤í† ì–´ ìƒì„± ë° ë¬¸ì„œ ì‚½ì… ì™„ë£Œ.")
        inserted_count = len(all_docs)

    except Exception as e:
        print(f"âŒ Milvus ì‚½ì… ì˜¤ë¥˜: {e}")
        inserted_count = 0
        vectorstore = None

    return {**state, "inserted": inserted_count, "rawDocs": all_docs, "vectorstore": vectorstore}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê·¸ë˜í”„ ë¹Œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def build_graph():
    g = StateGraph(IngestState)
    g.add_node("ensure_milvus", ensure_milvus_node)
    g.add_node("list_files", list_files_node)
    g.add_node("load_and_ingest", load_and_ingest_node)

    g.set_entry_point("ensure_milvus")
    g.add_edge("ensure_milvus", "list_files")
    g.add_edge("list_files", "load_and_ingest")
    g.add_edge("load_and_ingest", END)

    return g.compile()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë©”ì¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def main():
    print("ğŸš€ LangGraph ê¸°ë°˜ Milvus Ingest íŒŒì´í”„ë¼ì¸ ì‹œì‘")
    agent_app = build_graph()

    try:
        graph_image_path = "milvus_agent_workflow_rag.png"
        png_bytes = agent_app.get_graph().draw_mermaid_png(draw_method=MermaidDrawMethod.API)
        with open(graph_image_path, "wb") as f:
            f.write(png_bytes)
        print(f"\nâœ… LangGraph êµ¬ì¡°ê°€ '{graph_image_path}' íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"ê·¸ë˜í”„ ì‹œê°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

    initial_state: IngestState = {
        "docsPath": str(DOCS_DIR),
        "files": [],
        "rawDocs": [],
        "vectorstore": None,
        "inserted": 0,
        "collectionName": MILVUS_COLLECTION,
    }

    final_state = agent_app.invoke(initial_state)

    print("\nğŸ“¦ ê²°ê³¼ ìš”ì•½")
    print(f"  - ì²˜ë¦¬ëœ íŒŒì¼ ìˆ˜: {len(final_state['files'])}")
    print(f"  - Milvus ì»¬ë ‰ì…˜: {final_state['collectionName']}")
    print(f"  - ì‚½ì…ëœ ì²­í¬ ìˆ˜: {final_state['inserted']}")

if __name__ == "__main__":
    main()
